# 为什么会有浏览器并发限制
<img :src="$withBase('/1588856408747.png')" alt="各个浏览器并发限制数量">

## 什么是浏览器并发限制
浏览器并发限制指的是在同一域名下，浏览器可以同时发起多少个http请求。
具体场景如下图：
<img :src="$withBase('/Xnip2021-08-07_13-06-42.png')" alt="network查看并发限制">

## 从前端角度分析为什么限制
1. 当请求需要带cookie进行验证时，此时同域名下的其他资源请求(css、js、img)也都会带上cookie，但是这些资源本身并不需要cookie信息，这就造成了请求资源的浪费，也会拖慢请求资源的速度
2. 浏览器每发起一个请求就会在客户端开一个http请求的线程，如果没有浏览器并发限制，一次发起很多线程，在进行线程切换时对客户端也是一笔不小的开销，可能会导致客户端的卡顿等问题
3. 客户端的端口是有限的，浏览器每发送一个请求就会占用一个端口，如果不做并发限制，那么浏览器会无限制占用端口，让其他应用无法正常使用

## 从后端角度分析为什么限制
1. 服务器一般会限制同一ip在一段时间内的请求数量，如果请求数量超过了阈值，就会把这个ip禁用。如果浏览器不限制并发数，无限制发送请求，就容易导致后端把该客户端ip禁用
2. 每次接收到一个http请求客户端和服务端都会创建TCP链接，维护TCP链接是需要占用资源的，如果服务器TCP资源都被一个客户端给占用了，其他客户端就无法和服务创建新的TCP链接。造成类似 ddos 的效果。

## 有哪些解决方案
> 从前后端角度知道了为什么浏览器要限制同域名请求并发数后，可以从以下几个方面入手优化
### 域名发散
将同一个域名请求拆分成多个域名请求，例如 总共有100个servera.com的请求，可以分成servera.com serverb.com serverc.com serverd.com 每个域名分25个。假设当前浏览器并发数是6，那么就从一次发送 6个请求，变成了一次发送24个请求。但是这里并不是拆成越多域名越好，因为太多的域名可能会导致dns域名解析出现性能问题。一般建议4个域名左右即可。
::: tip 提示
浏览器并发限制并不会限制子域名，所以拆成 a.servera.com、b.servera.com、c.servera.com、d.servera.com 也是可以达到提升并发数效果
:::

### 静态资源不带cookie
域名发散提到了使用子域名也是可以实现解决并发限制数量，但是如果是一些静态资源不需要携带cookie的情况，用子域名方式也可能会把cookie给带上，所以静态资源最好不要用子域名方式进行加载。用单独域名加载能节省发送cookie的开销。

### 请求合并
既然多个请求会有并发限制，那么可以把能够合并的请求都放在一个请求中。最常见的就是"雪碧图"的使用了。网页中用到的图标比较多，一般都是一张张小图片，所以可以通过将多个小图片拼接成一个图片，然后通过背景图片定位方式定位展示。

### 懒加载
初始时只加载用户可见范围内的资源，当用户发生滚动等行为时，才动态加载接下来的资源。就能够避免一次性发送请求过多导致被并发限制堵塞。常用在瀑布流图片展示的场景

## 总结
在没有写这篇文章之前，我也知道浏览器有并发数限制，但是并不了解为什么会有这种限制。途中翻阅了一些资料，才了解到根本原因。所以在以后的工作生活中碰到一些貌似既定的规则时，多问一句为什么，争取了解到背后的深层原因。做业务、学习技术也都是如此。

::: tip 参考资料
[https://www.linkedin.com/pulse/why-does-your-browser-limit-number-concurrent-ishwar-rimal](https://www.linkedin.com/pulse/why-does-your-browser-limit-number-concurrent-ishwar-rimal)

[https://segmentfault.com/a/1190000039157302](https://segmentfault.com/a/1190000039157302)

[https://www.zhihu.com/question/20474326](https://www.zhihu.com/question/20474326)
:::